#!/bin/bash
#
# droid-discord - Discord-Droid Bridge CLI
# Session management and status commands
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Source library files
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/registry.sh"

usage() {
    cat <<EOF
Discord-Droid Bridge CLI (V2 - iTerm2 only)

Usage: droid-discord <command> [args]

Session Commands:
  register <threadId> [name]  Register current session with Discord thread
  deregister [threadId]       Deregister session
  status                      Show current session status
  list                        List all registered sessions

Bridge Commands:
  start                       Start the bridge daemon (foreground)
  start-bg                    Start the bridge daemon (background)
  stop                        Stop the bridge daemon
  logs                        Show bridge logs
  cleanup                     Remove sessions with dead PIDs

Examples:
  droid-discord register 1234567890123456789 "[myproject:main]"
  droid-discord start-bg
  droid-discord status
EOF
}

cmd_register() {
    local thread_id="$1"
    local thread_name="${2:-}"
    
    if [[ -z "$thread_id" ]]; then
        echo "Usage: droid-discord register <threadId> [name]"
        exit 1
    fi
    
    register_session "$thread_id" "$thread_name"
    
    # Save current session for cleanup on exit
    echo "$thread_id" > "$HOME/.factory/current-discord-session"
    
    echo ""
    echo "Export thread ID: export DROID_THREAD_ID=$thread_id"
}

cmd_deregister() {
    local thread_id="${1:-$DROID_THREAD_ID}"
    
    if [[ -z "$thread_id" ]]; then
        echo "No thread ID provided and DROID_THREAD_ID not set"
        exit 1
    fi
    
    deregister_session "$thread_id"
}

cmd_status() {
    show_session_status
}

cmd_list() {
    list_sessions
}

cmd_cleanup() {
    cleanup_dead_sessions
}

cmd_start() {
    exec "$SCRIPT_DIR/bridge-v2.sh"
}

cmd_start_bg() {
    if pgrep -f "bridge-v2.sh" > /dev/null; then
        echo "Bridge is already running"
        exit 1
    fi
    
    nohup "$SCRIPT_DIR/bridge-v2.sh" >> "$LOG_FILE" 2>&1 &
    echo "Bridge started (PID: $!)"
    echo "Logs: $LOG_FILE"
}

cmd_stop() {
    if ! pgrep -f "bridge-v2.sh" > /dev/null; then
        echo "Bridge is not running"
        exit 0
    fi
    
    pkill -f "bridge-v2.sh"
    pkill -f "fswatch.*discord-inbox"
    echo "Bridge stopped"
}

cmd_logs() {
    if [[ -f "$LOG_FILE" ]]; then
        tail -50 "$LOG_FILE"
    else
        echo "No log file at $LOG_FILE"
    fi
}

case "${1:-}" in
    register)    shift; cmd_register "$@" ;;
    deregister)  shift; cmd_deregister "$@" ;;
    status)      cmd_status ;;
    list)        cmd_list ;;
    cleanup)     cmd_cleanup ;;
    start)       cmd_start ;;
    start-bg)    cmd_start_bg ;;
    stop)        cmd_stop ;;
    logs)        cmd_logs ;;
    -h|--help|help|"") usage ;;
    *)           echo "Unknown: $1"; usage; exit 1 ;;
esac
